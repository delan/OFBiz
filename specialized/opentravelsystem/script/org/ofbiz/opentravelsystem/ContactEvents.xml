<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:noNamespaceSchemaLocation="http://www.ofbiz.org/dtds/simple-methods.xsd">
    <simple-method method-name="createCustomerAndCommunicationEvent" short-description="Create Customer and Communication Event" login-required="false">
          
        <if-not-empty field-name="parameters.USERNAME">                         
            <entity-and entity-name="ContactMech" list-name="contactMechs">
                <field-map field-name="infoString" env-name="parameters.USERNAME"/>
            </entity-and>
            <first-from-list entry-name="contactMech" list-name="contactMechs"/>
        </if-not-empty>      
        
        <if-not-empty field-name="contactMech.contactMechId"> 
            <entity-and entity-name="PartyContactMech" list-name="partyContactMechs">
                <field-map field-name="contactMechId" env-name="contactMech.contactMechId"/>
            </entity-and>
            <first-from-list entry-name="partyContactMech" list-name="partyContactMechs"/>
        </if-not-empty>  
        
        <if-not-empty field-name="partyContactMech.partyId"> 
            <entity-and entity-name="UserLogin" list-name="userLogins">
                <field-map field-name="partyId" env-name="partyContactMech.partyId"/>
            </entity-and>
            <first-from-list entry-name="userLogin" list-name="userLogins"/>
            <!-- Log the visitor in-->
            <set-current-user-login value-name="userLogin"/>    
        </if-not-empty>

        <!-- SIMPLE MAP PROCESSOR INVOEREN-->
        <!-- Do not create a new customer when emailaddress used in contactform is already known-->
        <if-empty field-name="userLoginId" map-name="userLogin">
                <if-compare field-name="parameters.contentName" operator="equals" value="Help">
                    <if-empty field-name="parameters.USER_FIRST_NAME">
                        <string-to-list string="Naam mist" message-field-name="USER_FIRST_NAME" list-name="error_list"/>                   
                    </if-empty>
                    <if-empty field-name="parameters.USER_LAST_NAME">
                        <string-to-list string="Bedrijfsnaam mist" message-field-name="USER_LAST_NAME" list-name="error_list"/>                   
                    </if-empty> 
                    <if-empty field-name="parameters.CUSTOMER_EMAIL">
                        <string-to-list string="Email mist" message-field-name="CUSTOMER_EMAIL" list-name="error_list"/>                   
                    </if-empty>                               
                    <if-empty field-name="parameters.subject">
                        <string-to-list string="Onderwerp mist" message-field-name="subject" list-name="error_list"/>                   
                    </if-empty>  
                    <if-empty field-name="parameters.content">
                        <string-to-list string="Bericht mist" message-field-name="content" list-name="error_list"/>                   
                    </if-empty>
                    <check-errors/> 
                </if-compare>    
                <call-simple-method method-name="createCustomer" xml-resource="org/ofbiz/opentravelsystem/CustomerEvents.xml"/>                         
        <else>
                <if-empty field-name="parameters.USER_FIRST_NAME">
                    <string-to-list string="Naam mist" message-field-name="USER_FIRST_NAME" list-name="error_list"/>                   
                </if-empty>
                <if-empty field-name="parameters.USER_LAST_NAME">
                    <string-to-list string="Bedrijfsnaam mist" message-field-name="USER_LAST_NAME" list-name="error_list"/>                   
                </if-empty>
                
               <if-compare field-name="parameters.contentName" operator="equals" value="Help">     
                    <if-empty field-name="parameters.subject">
                        <string-to-list string="Onderwerp mist" message-field-name="subject" list-name="error_list"/>                   
                    </if-empty>  
                    <if-empty field-name="parameters.content">
                        <string-to-list string="Bericht mist" message-field-name="content" list-name="error_list"/>                   
                    </if-empty>
                    <check-errors/>
               <else>
                   <if-empty field-name="parameters.KVK">
                       <string-to-list string="KVK nummer mist" message-field-name="KVK" list-name="error_list"/>                   
                   </if-empty>
                   <if-empty field-name="parameters.CUSTOMER_ADDRESS1">
                       <string-to-list string="Adreslijn 1 mist" message-field-name="CUSTOMER_ADDRESS1" list-name="error_list"/>                   
                   </if-empty>
                   <if-empty field-name="parameters.CUSTOMER_POSTAL_CODE">
                       <string-to-list string="Postcode mist" message-field-name="CUSTOMER_POSTAL_CODE" list-name="error_list"/>                   
                   </if-empty>
                   <if-empty field-name="parameters.CUSTOMER_CITY">
                       <string-to-list string="Stad mist" message-field-name="CUSTOMER_CITY" list-name="error_list"/>                   
                   </if-empty>
                   <check-errors/>                     
               </else>    
               </if-compare>                                                             
        </else>
        </if-empty>
        
        <if-compare field-name="parameters.contentName" operator="equals" value="Help">
        <set field="parameters.partyIdFrom" from-field="userLogin.partyId"/>                        
        <call-simple-method method-name="createCommunicationEvent" xml-resource="org/ofbiz/party/communication/CommunicationEventServices.xml"/>
        </if-compare>
        
        <set value="Bedankt voor uw belangstelling. Wij zullen zo snel mogelijk contact met u opnemen." field="_event_message_"/>
        
    </simple-method>    
</simple-methods>       