<?xml version="1.0"?>

<!--
 *  Copyright (c) 2001 The Open For Business Project and respected authors.
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a
 *  copy of this software and associated documentation files (the "Software"),
 *  to deal in the Software without restriction, including without limitation
 *  the rights to use, copy, modify, merge, publish, distribute, sublicense,
 *  and/or sell copies of the Software, and to permit persons to whom the
 *  Software is furnished to do so, subject to the following conditions:
 *
 *  The above copyright notice and this permission notice shall be included
 *  in all copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 *  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 *  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 *  CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT
 *  OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 *  THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 *  This is the  Open for Business CORE component build script.
 *  $Id$
-->

<project name="Open For Business Main Build" default="deploy" basedir=".">


    <!-- ================================================================== -->
    <!-- Install OFBIZ Components in JBoss & Tomcat                         -->
    <!-- ================================================================== -->

    <target name="install-jboss">
        <property environment="env" />
        <property name="jboss.dir"      value="${env.JBOSS_HOME}" />
        
        <copy file="setup/jboss/bin/ofbiz.bat"
            toDir="${jboss.dir}/bin" />
        <copy file="setup/jboss/bin/ofbiz.sh"
            toDir="${jboss.dir}/bin" />
        
        <copy toDir="${jboss.dir}/conf/ofbiz">
          <fileset dir="${jboss.dir}/conf/tomcat"/>
        </copy>
        <move file="${jboss.dir}/conf/ofbiz/jboss.jcml"
            toFile="${jboss.dir}/conf/ofbiz/jboss.orig.jcml" />
        <move file="${jboss.dir}/conf/ofbiz/jboss.conf"
            toFile="${jboss.dir}/conf/ofbiz/jboss.orig.conf" />
        
        <copy file="setup/jboss/conf/ofbiz/jboss.jcml"
            toDir="${jboss.dir}/conf/ofbiz" />
        <copy file="setup/jboss/conf/ofbiz/jboss.conf"
            toDir="${jboss.dir}/conf/ofbiz" />
    </target>

    <target name="install-tomcat">
        <property environment="env" />
        <property name="tomcat.dir"      value="${env.TOMCAT_HOME}" />
    
        <move file="${tomcat.dir}/conf/server.xml"
            toFile="${tomcat.dir}/conf/server.orig.xml" />
        <copy file="setup/tomcat/conf/server.xml"
             toDir="${tomcat.dir}/conf" />
    </target>

    <target name="install" depends="install-jboss, install-tomcat">
    </target>

    <!-- ================================================================== -->
    <!-- Initialization of all property settings                            -->
    <!-- ================================================================== -->

    <target name="init">
        <property environment="env" />
        <property name="home.dir"        value="${env.OFBIZ_HOME}" />
        <property name="etc.dir"        value="${home.dir}/etc" />
        <property name="lib.dir"        value="${home.dir}/lib" />
        <property name="j2eedeploy.dir"  value="${home.dir}/j2eedeploy" />
    </target>


    <!-- ================================================================== -->
    <!-- Removes all created files and directories                          -->
    <!-- ================================================================== -->

    <target name="clean" depends="clean-lib">
        <echo message="[clean] ===== Cleaning core =====" />
        <ant dir="core" target="clean" />        
        <echo message="[clean] ===== Cleaning commonapp =====" />
        <ant dir="commonapp" target="clean" />        
        <echo message="[clean] ===== Cleaning ecommerce =====" />
        <ant dir="ecommerce" target="clean" />        
        <echo message="[clean] ===== Done Cleaning =====" />
    </target>

    <target name="clean-lib" depends="init">
        <delete dir="${etc.dir}" />        
        <delete dir="${lib.dir}" />
        <delete dir="${j2eedeploy.dir}" />
    </target>


    <!-- ================================================================== -->
    <!-- Makes sure the needed directory structure is in place              -->
    <!-- ================================================================== -->

    <target name="prepare" depends="clean-lib">
        <mkdir dir="${etc.dir}" />
        <mkdir dir="${lib.dir}" />
        <mkdir dir="${j2eedeploy.dir}" />
    </target>

    <!-- ================================================================== -->
    <!-- Build Modules                                                     -->
    <!-- ================================================================== -->

    <target name="build" depends="">
        <echo message="[build] ===== Building core =====" />
        <ant dir="core" />
        <echo message="[build] ===== Building commonapp =====" />
        <ant dir="commonapp" />
        <echo message="[build] ===== Building ecommerce =====" />
        <ant dir="ecommerce" />
        <echo message="[build] ===== Done Building =====" />
    </target>
	
    <!-- ================================================================== -->
    <!-- Deploy the app                                                     -->
    <!-- ================================================================== -->
	
    <!-- Copy all files necessary for running IN PLACE (ie: OFBIZ_HOME == .) -->
    <target name="deploy" depends="build, prepare">
        <copy file="commonapp/etc/servers.properties"
            toFile="${etc.dir}/servers.properties" />
        <copy file="commonapp/etc/debug.properties"
            toFile="${etc.dir}/debug.properties" />
        <copy file="commonapp/etc/cache.properties"
            toFile="${etc.dir}/cache.properties" />
        
        <copy file="core/lib/ofbcore.jar"
            toFile="${lib.dir}/ofbcore.jar" />        
        <copy file="core/lib/ofbcore-ejb.jar"
            toFile="${j2eedeploy.dir}/ofbcore-ejb.jar" />    

        <copy file="commonapp/lib/ofbcommonapp.jar"
            toFile="${lib.dir}/ofbcommonapp.jar" />        

        <copy file="ecommerce/etc/ecommerce.properties"
            toFile="${etc.dir}/ecommerce.properties" />
        <copy file="ecommerce/lib/ofbecom.jar"
            toFile="${lib.dir}/ofbecom.jar" />
    </target>

    <!-- Copy all files necessary for EXTERNAL running -->
    <target name="external-deploy" depends="deploy">
        <mkdir dir="${home.dir}/commonapp/entitydef" />
        <copy file="commonapp/entitydef/entitymodel.xml"
            toFile="${home.dir}/commonapp/entitydef/entitymodel.xml" />
        <copy file="commonapp/entitydef/fieldtypemysql.xml"
            toFile="${home.dir}/commonapp/entitydef/fieldtypemysql.xml" />
    
        <copy file="commonapp/lib/commonapp-ext.war"
            toFile="${j2eedeploy.dir}/commonapp-ext.war" />
    </target>

</project>

