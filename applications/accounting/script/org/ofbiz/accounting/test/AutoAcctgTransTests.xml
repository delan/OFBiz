<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/simple-methods.xsd">

    <!-- Test case for Accounting Transaction on Purchase -->    
    <simple-method method-name="testAcctgTransOnPoReceipts" short-description="Test case for Accounting Transaction on Receipts of Purchase Order." login-required="false">
        <!-- Precondition : shipment is created from supplier and order items are issued  -->
        <!-- create a purchase order using following: 
             Supplier : DemoSupplier
             Item     : WG-1111
             Quantity : 10 -->
             
        <!-- Post condition : Credit in account 214000 - UNINVOICED ITEM RECEIPT amount = grand total of order.
                              Debit in account 140000- INVENTORY amount = grand total of order.  -->

        <!-- set few variables so that they can be changed easily to test with different values -->
        <set field="orderId" value="WS10000"/>
        <set field="productId" value="WG-1111"/>
        <set field="orderItemSeqId" value="00001"/>
        <set field="shipmentId" value="10000"/>

        <entity-one entity-name="UserLogin" value-name="userLogin">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.inventoryItemTypeId" value="NON_SERIAL_INV_ITEM"/>
        <set field="serviceCtx.productId" from-field="productId"/>
        <set field="serviceCtx.facilityId" value="WebStoreWarehouse"/>
        <set field="serviceCtx.quantityAccepted" value="10" type="Double"/>
        <set field="serviceCtx.quantityRejected" value="0" type="Double"/>
        <set field="serviceCtx.shipmentId" from-field="shipmentId"/>
        <set field="serviceCtx.orderId" from-field="orderId"/>
        <set field="serviceCtx.orderItemSeqId" from-field="orderItemSeqId"/>
        
        <call-service service-name="receiveInventoryProduct" in-map-name="serviceCtx"/>
        <entity-condition  entity-name="AcctgTransEntry" list-name="acctgTransEntries">
            <condition-expr field-name="productId" env-name="productId"/>
        </entity-condition>
        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate list-name="acctgTransEntries" entry-name="acctgTransEntry">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
                <assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="UNINVOICED_SHIP_RCPT"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="214000"/>
                </assert>
            <else>
                <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
                    <assert>
                        <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="INVENTORY_ACCOUNT"/>
                        <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="140000"/>
                    </assert>
                </if-compare>
            </else>    
            </if-compare>
        </iterate>
    </simple-method>
    
    <simple-method method-name="testAcctgTransOnEditPoInvoice" short-description="Test case for Purchase Invoices: editing, adding taxes and shipping charges and posting to GL" login-required="false">
        <!-- Precondition: To the Purchase Invoice created add taxes and two different shipping charges
            1. for taxes: set "Invoice Item Type" = "Invoice Sales Tax" and "Unit Price" = 10$
            2. for the first shipping charge: set "Invoice Item Type" = "Invoice Shipping And Handling" and "Unit Price" = 5$
            3. for the second shipping charge: set "Invoice Item Type" = "Invoice Shipping And Handling", set "Override Gl Account Id" = "516100" and "Unit Price" = 5$
        -->
        <!-- Post condition: When status is set to ready, an accounting transaction is automatically posted to the GL:
            * Credit; in account 210000 - "ACCOUNTS PAYABLE"; amount: 290$
            * Debit; in account 214000 - "UNINVOICED ITEM RECEIPTS"; amount: 270$
            * Debit; in account 516100 - "PURCHASE ORDER ADJUSTMENTS"; amount: 10$
            * Debit; in account 510000 - "FREIGHT IN"; amount: 5$
            * Debit; in account 516100 - "PURCHASE ORDER ADJUSTMENTS"; amount: 5$
        -->

        <set field="invoiceId" value="10000"/>
        <entity-one entity-name="UserLogin" value-name="userLogin">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.statusId" value="INVOICE_READY"/>
        <set field="serviceCtx.invoiceId" from-field="invoiceId"/>
        <call-service service-name="setInvoiceStatus" in-map-name="serviceCtx"/>
        <entity-one entity-name="Invoice" value-name="invoice">
            <field-map field-name="invoiceId" env-name="invoiceId"/>
        </entity-one>
        <get-related value-name="invoice" relation-name="AcctgTrans" list-name="acctgTransList"/> 
        <first-from-list list-name="acctgTransList" entry-name="acctgTrans"/>
        <get-related value-name="acctgTrans" relation-name="AcctgTransEntry" list-name="acctgTransEntries"/>
        
        <set field="debitTotal" type="Double" value="0.0"/>
        <set field="creditTotal" type="Double" value="0.0"/>
        
        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate list-name="acctgTransEntries" entry-name="acctgTransEntry">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
                <assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="ACCOUNTS_PAYABLE"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="210000"/>
                </assert>
                <calculate field-name="creditTotal">
                    <calcop operator="add" field-name="acctgTransEntry.origAmount"/>
                </calculate>
            <else>
                <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
                    <calculate field-name="debitTotal">
                        <calcop operator="add" field-name="acctgTransEntry.origAmount"/>
                    </calculate>
                </if-compare>
            </else>    
            </if-compare>
        </iterate>
        <assert>
            <if-compare field-name="debitTotal" operator="equals" value="creditTotal"/>
        </assert>            
    </simple-method>
    
    <simple-method method-name="testAcctgTransOnPaymentSentToSupplier" short-description="Test case for Payment sent to supplier for purchase invoice." login-required="false">
        <!-- 
            Precondition: New payment is created for: supplierId = "DemoSupplier", "Payment Type ID" = "Vendor Payment" and 
                          a proper "Payment Method Type" (e.g. "Electronic Funds Transfer"), amount = $290
            
            Post condition: On payment's status is sent: a double-entry accounting transaction is automatically posted to the GL:
                * Credit; in account 111100 - "GENERAL CHECKING ACCOUNT"; amount: 290$; however this depends on the "Payment method type" selected; 
                * Debit; in account 210000 - "ACCOUNTS PAYABLE"; amount: 290$
         -->

        <set field="paymentId" value="10000"/>
        <entity-one entity-name="UserLogin" value-name="userLogin">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.paymentId" from-field="paymentId"/>
        <set field="serviceCtx.statusId" value="PMNT_SENT"/>

        <call-service service-name="setPaymentStatus" in-map-name="serviceCtx"/>
        <entity-one entity-name="Payment" value-name="payment">
            <field-map field-name="paymentId" env-name="paymentId"/>
        </entity-one>
        <get-related value-name="payment" relation-name="AcctgTrans" list-name="acctgTransList"/> 
        <first-from-list list-name="acctgTransList" entry-name="acctgTrans"/>
        <get-related value-name="acctgTrans" relation-name="AcctgTransEntry" list-name="acctgTransEntries"/>

        <set field="debitTotal" type="Double" value="0.0"/>
        <set field="creditTotal" type="Double" value="0.0"/>
        
        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate list-name="acctgTransEntries" entry-name="acctgTransEntry">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
            <!--<assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="GENERAL_CHECKING_ACCOUNT"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="111100"/>
                </assert>-->
                <set field="creditTotal" from-field="acctgTransEntry.origAmount"/>
            <else>
                <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
                    <assert>
                        <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="ACCOUNTS_PAYABLE"/>
                        <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="210000"/>
                    </assert>
                    <set field="debitTotal" from-field="acctgTransEntry.origAmount"/>
                </if-compare>
            </else>    
            </if-compare>
        </iterate>
        <assert>
            <if-compare field-name="debitTotal" operator="equals" value="creditTotal"/>
        </assert>   
    </simple-method>

    <!-- Test case for Accounting Transaction on Sales -->
    <simple-method method-name="testAcctgTransForSalesOrderShipments" short-description="Creation and Shipments of sales order" login-required="false">
        <!-- Precondition : 
             1. create a sales order
             2. from the order view screen, approve the order
             3. from the order view screen, create a shipment to the customer (click on "New Shipment For Ship Group" and then click on the "Update" button in the next screen)         
        -->
        <!-- Following process is tested by test case:
             1. issue (assign) the order items to the shipment: select the "Order Items" tab and then click on "Issue All"; this action will generate and post to the GL the accounting transaction for the items taken from the warehouse and ready to be shipped 
        -->
        <!-- Post condition: all order items will be issued and it will generate and post to the GL the accounting transaction for the items taken from the warehouse and ready to be shipped
              * Credit; in account:140000 - Account Type:"INVENTORY_ACCOUNT"
              * Debit; in account:500000 - Account Type:"COGS_ACCOUNT"
        -->

        <set field="shipmentId" value="10000"/>
        <set field="orderId" value="WSCO10000"/>
        <set field="shipGroupSeqId" value="00001"/>
        <set field="orderItemSeqId" value="00001"/>
        <set field="inventoryItemId" value="9001"/>
        <set field="quantity" value="2" type="Double"/>
        <set field="productId" value="GZ-2644"/>

        <entity-one entity-name="UserLogin" value-name="userLogin" auto-field-map="false">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.shipmentId" from-field="shipmentId"/>
        <set field="serviceCtx.orderId" from-field="orderId"/>
        <set field="serviceCtx.shipGroupSeqId" from-field="shipGroupSeqId"/>
        <set field="serviceCtx.orderItemSeqId" from-field="orderItemSeqId"/>
        <set field="serviceCtx.inventoryItemId" from-field="inventoryItemId"/>
        <set field="serviceCtx.quantity" from-field="quantity"/>
        <call-service service-name="issueOrderItemShipGrpInvResToShipment" in-map-name="serviceCtx"/>

        <entity-condition entity-name="AcctgTransEntry" list-name="acctgTransEntryList">
            <condition-expr field-name="productId" operator="equals" env-name="productId"/>
        </entity-condition>
        
        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate list-name="acctgTransEntryList" entry-name="acctgTransEntry">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
                <assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="INVENTORY_ACCOUNT"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="140000"/>
                </assert>
            <else>
                <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
                    <assert>
                        <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="COGS_ACCOUNT"/>
                        <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="500000"/>
                    </assert>
                </if-compare>
            </else>
            </if-compare>
        </iterate>
    </simple-method>

    <simple-method method-name="testAcctgTransOnSalesInvoice" short-description="Test case for Accounting Transaction for sales invoice" login-required="false">
        <!-- Precondition:
            1. Create a sales order
            2. From the order view screen, approve the order
            3. From the order view screen, create a shipment to the customer (click on "New Shipment For Ship Group" and then click on the "Update" button in the next screen)
            4. Issue the order items to the shipment: select the "Order Items" tab and then click on "Issue All."
            5. From the shipment detail screen of the shipment created in the previous step (there is a link to it from the order detail screen), set the status of the shipment to "pack"(Click on "Edit" and then from statusId drop down select statusId = "Pack" and then click update); this action will generate a sales invoice
        -->
        <!-- Following process is tested by test case:
             1. Go to the invoice detail screen (there is a link to the invoice from the order detail screen) and click on the "set status to ready"; this action will generate and post to the GL the accounting transaction for the sales invoice
        -->
        <!-- Post condition: "Set status to ready"; This action will generate and post to the GL the accounting transaction for the sales invoice
              * Credit; in account=400000 - Account Type="SALES_ACCOUNT"
              * Debit; in  account=120000 - Account Type="ACCOUNTS_RECEIVABLE"
        -->

        <set field="invoiceId" value="CI1"/>
        
        <entity-one entity-name="UserLogin" value-name="userLogin">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.invoiceId" from-field="invoiceId"/>
        <set field="serviceCtx.statusId" value="INVOICE_READY"/>
        <call-service service-name="setInvoiceStatus" in-map-name="serviceCtx"/>

        <entity-one entity-name="Invoice" value-name="invoice">
            <field-map field-name="invoiceId" env-name="invoiceId"/>
        </entity-one>
        <get-related value-name="invoice" relation-name="AcctgTrans" list-name="acctgTransList"/>
        <first-from-list list-name="acctgTransList" entry-name="acctgTrans"/>
        <get-related value-name="acctgTrans" relation-name="AcctgTransEntry" list-name="acctgTransEntries"/>

        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate entry-name="acctgTransEntry" list-name="acctgTransEntries">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
            <!--<assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="SALES_ACCOUNT"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="400000"/>
                </assert>-->
            <else>
                <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
                    <assert>
                        <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="ACCOUNTS_RECEIVABLE"/>
                        <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="120000"/>
                    </assert>
                </if-compare>
            </else>
            </if-compare>
        </iterate>
        <check-errors/>
    </simple-method>
    
    <simple-method method-name="testAcctgTransOnPaymentReceivedFromCustomer" short-description="Test case on Payment Received from customer for Sales Invoice" login-required="false">
        <!-- Precondition :- 
            1. Click on the Payment top menu in the Accounting application, then click on the "Create New Payment" link.
            2. In the "New incoming payment" box, set the customer id in the "From Party ID" field; then set "Payment Type ID" = "Customer Payment" and a proper "Payment Method Type" (e.g. "Electronic Funds Transfer"); then set the "amount" and submit the form
        -->
        <!-- Following process is tested by test case:
             1. From the payment detail screen, when you are ready to post the payment to the GL, click on the "Status to Received" link
        -->
        <!-- Post condition: "Status to Received", Received Payments. When you are ready to post the payment to the GL this action will generate and post to the GL the accounting transaction for the items taken from the warehouse and ready to be shipped:
              * Credit; in glAccountId=120000 - glAccountTypeId="ACCOUNTS_RECEIVABLE"
              * Debit; in glAccountId=112000 - glAccountTypeId="UNDEPOSITED_RECEIPTS"
        -->

        <set field="paymentId" value="10000"/>
        <entity-one entity-name="UserLogin" value-name="userLogin">
            <field-map field-name="userLoginId" value="system"/>
        </entity-one>
        <set field="serviceCtx.userLogin" from-field="userLogin"/>
        <set field="serviceCtx.paymentId" from-field="paymentId"/>
        <set field="serviceCtx.statusId" value="PMNT_RECEIVED"/>
        <call-service service-name="setPaymentStatus" in-map-name="serviceCtx"/>

        <entity-one entity-name="Payment" value-name="payment">
            <field-map field-name="paymentId" env-name="paymentId"/>
        </entity-one>
        <get-related value-name="payment" relation-name="AcctgTrans" list-name="acctgTransList"/>
        <first-from-list list-name="acctgTransList" entry-name="acctgTrans"/>
        <get-related value-name="acctgTrans" relation-name="AcctgTransEntry" list-name="acctgTransEntries"/>
        <set field="debitTotal" type="Double" value="0.0"/>
        <set field="creditTotal" type="Double" value="0.0"/>

        <assert><not><if-empty field-name="acctgTransEntries"/></not></assert>
        <iterate entry-name="acctgTransEntry" list-name="acctgTransEntries">
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="C">
            <!--<assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="ACCOUNTS_RECEIVABLE"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="120000"/>
                </assert>-->
                <calculate field-name="creditTotal">
                    <calcop operator="add" field-name="acctgTransEntry.origAmount"/>
                </calculate>
            </if-compare>
            <if-compare field-name="acctgTransEntry.debitCreditFlag" operator="equals" value="D">
            <!--<assert>
                    <if-compare field-name="acctgTransEntry.glAccountTypeId" operator="equals" value="UNDEPOSITED_RECEIPTS"/>
                    <if-compare field-name="acctgTransEntry.glAccountId" operator="equals" value="112000"/>
                </assert>-->
                <calculate field-name="debitTotal">
                    <calcop operator="add" field-name="acctgTransEntry.origAmount"/>
                </calculate>
            </if-compare>
        </iterate>
        <assert>
            <if-compare field-name="debitTotal" operator="equals" value="creditTotal"/>
        </assert>
        <check-errors/>
    </simple-method>    
</simple-methods>