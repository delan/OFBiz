<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE simple-methods PUBLIC "-//OFBiz//DTD Simple Methods//EN" "http://www.ofbiz.org/dtds/simple-methods.dtd">

<!--
  *  Copyright (c) 2002 The Open For Business Project - www.ofbiz.org
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a
 *  copy of this software and associated documentation files (the "Software"),
 *  to deal in the Software without restriction, including without limitation
 *  the rights to use, copy, modify, merge, publish, distribute, sublicense,
 *  and/or sell copies of the Software, and to permit persons to whom the
 *  Software is furnished to do so, subject to the following conditions:
 *
 *  The above copyright notice and this permission notice shall be included
 *  in all copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 *  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 *  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 *  CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT
 *  OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 *  THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * @author <a href="mailto:jonesde@ofbiz.org">David E. Jones</a>
 * @version 1.0
 * Created on April 2, 2002
 -->

<simple-methods>
    <!-- InventoryItem methods -->
    <simple-method method-name="createInventoryItem" short-description="Create an InventoryItem">
        <check-permission permission="CATALOG" action="_CREATE">
        	<alt-permission permission="FACILITY" action="_CREATE"/>
        	<fail-message message="Security Error: to run createInventoryItem you must have the CATALOG_CREATE, CATALOG_ADMIN, FACILITY_CREATE, or FACILITY_ADMIN permission"/>
        </check-permission>
        <check-errors/>

        <make-value value-name="newEntity" entity-name="InventoryItem"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>

        <sequenced-id-to-env sequence-name="InventoryItem" env-name="inventoryItemId"/>
        <to-string field-name="inventoryItemId"/>
        <env-to-field env-name="inventoryItemId" map-name="newEntity"/>
        <field-to-result field-name="inventoryItemId" result-name="inventoryItemId"/>

        <create-value value-name="newEntity"/>
    </simple-method>
    <simple-method method-name="updateInventoryItem" short-description="Update an InventoryItem">
        <check-permission permission="CATALOG" action="_UPDATE">
        	<alt-permission permission="FACILITY" action="_UPDATE"/>
        	<fail-message message="Security Error: to run updateInventoryItem you must have the CATALOG_UPDATE, CATALOG_ADMIN, FACILITY_UPDATE, or FACILITY_ADMIN permission"/>
        </check-permission>
        <check-errors/>

        <make-value entity-name="InventoryItem" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <set-nonpk-fields map-name="parameters" value-name="lookedUpValue"/>
        <store-value value-name="lookedUpValue"/>
    </simple-method>
    <simple-method method-name="deleteInventoryItem" short-description="Delete an InventoryItem">
        <check-permission permission="CATALOG" action="_DELETE">
        	<alt-permission permission="FACILITY" action="_DELETE"/>
        	<fail-message message="Security Error: to run deleteInventoryItem you must have the CATALOG_DELETE, CATALOG_ADMIN, FACILITY_DELETE, or FACILITY_ADMIN permission"/>
        </check-permission>
        <check-errors/>

        <make-value entity-name="InventoryItem" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <remove-value value-name="lookedUpValue"/>
    </simple-method>

    <simple-method method-name="createInventoryItemVariance" short-description="Create an InventoryItemVariance">
        <check-permission permission="CATALOG" action="_CREATE">
        	<alt-permission permission="FACILITY" action="_CREATE"/>
        	<fail-message message="Security Error: to run createInventoryItemVariance you must have the CATALOG_CREATE, CATALOG_ADMIN, FACILITY_CREATE, or FACILITY_ADMIN permission"/>
        </check-permission>
        
        <!-- add changes to availableToPromise and quantityOnHand -->
        <make-value value-name="inventoryItemLookup" entity-name="InventoryItem"/>
        <set-pk-fields map-name="parameters" value-name="inventoryItemLookup"/>
        <find-by-primary-key map-name="inventoryItemLookup" value-name="inventoryItem"/>

		<if-compare field-name="inventoryItemTypeId" map-name="inventoryItem" operator="not-equals" value="NON_SERIAL_INV_ITEM">
			<string-to-list string="Can only create an InventoryItemVariance for a Non-Serialized Inventory Item" list-name="error_list"/>
		</if-compare>
        <check-errors/>

        <calculate field-name="availableToPromise" map-name="inventoryItem">
        	<calcop field-name="availableToPromise" map-name="inventoryItem" operator="add">
        		<calcop field-name="availableToPromise" map-name="parameters" operator="get"/>
        	</calcop>
        </calculate>
        <calculate field-name="quantityOnHand" map-name="inventoryItem">
        	<calcop field-name="quantityOnHand" map-name="inventoryItem" operator="add">
        		<calcop field-name="quantityOnHand" map-name="parameters" operator="get"/>
        	</calcop>
        </calculate>
        <store-value value-name="inventoryItem"/>

        <make-value value-name="newEntity" entity-name="InventoryItemVariance"/>
        <set-pk-fields map-name="parameters" value-name="newEntity"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        <create-value value-name="newEntity"/>
        
        <!-- TODO: (possibly a big deal?) check to see if any reserved inventory needs to be changed because of a change in availableToPromise -->
        <!-- TODO: make sure availableToPromise is never greater than the quantityOnHand -->
    </simple-method>
    <simple-method method-name="createPhysicalInventory" short-description="Create a PhysicalInventory">
        <check-permission permission="CATALOG" action="_CREATE">
        	<alt-permission permission="FACILITY" action="_CREATE"/>
        	<fail-message message="Security Error: to run createPhysicalInventory you must have the CATALOG_CREATE, CATALOG_ADMIN, FACILITY_CREATE, or FACILITY_ADMIN permission"/>
        </check-permission>
        <check-errors/>

        <make-value value-name="newEntity" entity-name="PhysicalInventory"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        
        <if-empty field-name="newEntity.physicalInventoryDate">
        	<now-timestamp-to-env env-name="newEntity.physicalInventoryDate"/>
        </if-empty>
        <if-empty field-name="newEntity.partyId">
        	<field-to-field field-name="partyId" map-name="userLogin" to-map-name="newEntity"/>
        </if-empty>

        <sequenced-id-to-env sequence-name="PhysicalInventory" env-name="physicalInventoryId"/>
        <to-string field-name="physicalInventoryId"/>
        <env-to-field env-name="physicalInventoryId" map-name="newEntity"/>
        <field-to-result field-name="physicalInventoryId" result-name="physicalInventoryId"/>

        <create-value value-name="newEntity"/>
    </simple-method>
    <simple-method method-name="createPhysicalInventoryAndVariance" short-description="Create a PhysicalInventory and an InventoryItemVariance">
    	<set-service-fields service-name="createPhysicalInventory" map-name="parameters" to-map-name="createPhysicalInventoryMap"/>
    	<call-service service-name="createPhysicalInventory" in-map-name="createPhysicalInventoryMap">
    		<result-to-field result-name="physicalInventoryId" field-name="physicalInventoryId" map-name="parameters"/>
    		<result-to-result result-name="physicalInventoryId" service-result-name="physicalInventoryId"/>
    	</call-service>
    	<set-service-fields service-name="createInventoryItemVariance" map-name="parameters" to-map-name="createInventoryItemVarianceMap"/>
    	<call-service service-name="createInventoryItemVariance" in-map-name="createInventoryItemVarianceMap"/>
    </simple-method>

    <!-- ProductFacility methods -->
    <simple-method method-name="createProductFacility" short-description="Create a ProductFacility">
		<string-to-field string="createProductFacility" field-name="callingMethodName"/>
		<string-to-field string="CREATE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value value-name="newEntity" entity-name="ProductFacility"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        <set-pk-fields map-name="parameters" value-name="newEntity"/>
        <create-value value-name="newEntity"/>
    </simple-method>
    <simple-method method-name="updateProductFacility" short-description="Update a ProductFacility">
		<string-to-field string="updateProductFacility" field-name="callingMethodName"/>
		<string-to-field string="UPDATE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value entity-name="ProductFacility" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <set-nonpk-fields map-name="parameters" value-name="lookedUpValue"/>
        <store-value value-name="lookedUpValue"/>
    </simple-method>
    <simple-method method-name="deleteProductFacility" short-description="Delete a ProductFacility">
		<string-to-field string="deleteProductFacility" field-name="callingMethodName"/>
		<string-to-field string="DELETE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value entity-name="ProductFacility" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <remove-value value-name="lookedUpValue"/>
    </simple-method>

    <!-- ProductFacilityLocation methods -->
    <simple-method method-name="createProductFacilityLocation" short-description="Create a ProductFacilityLocation">
		<string-to-field string="createProductFacilityLocation" field-name="callingMethodName"/>
		<string-to-field string="CREATE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value value-name="newEntity" entity-name="ProductFacilityLocation"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        <set-pk-fields map-name="parameters" value-name="newEntity"/>
        <create-value value-name="newEntity"/>
    </simple-method>
    <simple-method method-name="updateProductFacilityLocation" short-description="Update a ProductFacilityLocation">
		<string-to-field string="updateProductFacilityLocation" field-name="callingMethodName"/>
		<string-to-field string="UPDATE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value entity-name="ProductFacilityLocation" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <set-nonpk-fields map-name="parameters" value-name="lookedUpValue"/>
        <store-value value-name="lookedUpValue"/>
    </simple-method>
    <simple-method method-name="deleteProductFacilityLocation" short-description="Delete a ProductFacilityLocation">
		<string-to-field string="deleteProductFacilityLocation" field-name="callingMethodName"/>
		<string-to-field string="DELETE" field-name="checkAction"/>
		<string-to-field string="FACILITY" field-name="alternatePermissionRoot"/>
    	<call-simple-method method-name="checkProductRelatedPermission" xml-resource="org/ofbiz/product/product/ProductServices.xml"/>
        <check-errors/>

        <make-value entity-name="ProductFacilityLocation" value-name="lookupPKMap"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key map-name="lookupPKMap" value-name="lookedUpValue"/>
        <remove-value value-name="lookedUpValue"/>
    </simple-method>

    <!-- ================================================================ -->
    <!-- Check/Reserve Inventory Services -->
    <!-- ================================================================ -->

    <simple-method method-name="getProductInventoryAvailable" short-description="Get Inventory Available for a Product" login-required="false" use-transaction="false">
        <!--
            this method can be called with some optional parameters:
                -facilityId
                -containerId
            If the service definitions are used then only one of these two will ever be specified, or neither of them.

            Whatever it is called with, it will basicly get a list of InventoryItems and total the available amount.
        -->

        <!-- this is not normally needed...
        <log level="info"><string value="Getting inventory available to promise count; parameters are: "/><field field-name="parameters"/></log>
        <log level="info" message="foo foo: "><string value="Getting inventory available to promise count; productId is: "/><field field-name="productId" map-name="parameters"/></log>
        -->
        
        <field-to-field field-name="productId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <field-to-field field-name="facilityId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <field-to-field field-name="containerId" map-name="parameters" to-map-name="lookupFieldMap"/>

        <!-- we might get away with a cache here since real serious errors will occur during the reservation service... but only if we need the speed -->
        <find-by-and entity-name="InventoryItem" map-name="lookupFieldMap" list-name="inventoryItems"/> <!-- use-cache="true" -->

        <calculate field-name="availableToPromise" map-name="parameters"><number value="0"/></calculate>
        <iterate entry-name="inventoryItem" list-name="inventoryItems">
            <if-compare value="SERIALIZED_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
                <if-compare value="INV_AVAILABLE" operator="equals" field-name="statusId" map-name="inventoryItem">
                    <calculate field-name="availableToPromise" map-name="parameters">
                        <calcop operator="get" field-name="availableToPromise" map-name="parameters"/>
                        <number value="1.0"/>
                    </calculate>
                </if-compare>
            </if-compare>
            <if-compare value="NON_SERIAL_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
                <if-not-empty field-name="availableToPromise" map-name="inventoryItem">
                    <calculate field-name="availableToPromise" map-name="parameters">
                        <calcop operator="get" field-name="availableToPromise" map-name="parameters"/>
                        <calcop operator="get" field-name="availableToPromise" map-name="inventoryItem"/>
                    </calculate>
                </if-not-empty>
            </if-compare>
        </iterate>

        <field-to-result field-name="availableToPromise" map-name="parameters"/>
    </simple-method>
    
    <simple-method method-name="getInventoryAlerts" short-description="getInventoryAlerts" login-required="false">
        <field-to-field field-name="catalogId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <find-by-and entity-name="InventoryAlert" map-name="lookupFieldMap" list-name="inventoryAlerts" />
        <iterate entry-name="inventoryAlert" list-name="inventoryAlerts">
            <field-to-field map-name="inventoryAlert" field-name="productId" to-map-name="inventoryLookup" />
            <call-service service-name="getProductInventoryAvailable" in-map-name="inventoryLookup">
                <result-to-field result-name="availableToPromise" map-name="getInventoryResults" />
            </call-service>
            <if-compare-field field-name="availableToPromise" map-name="getInventoryResults" operator="less" to-map-name="inventoryAlert" to-field-name="inventoryLevel" type="Double" >
                <field-to-field map-name="inventoryAlert" field-name="productId" to-map-name="alertResult" />
                <field-to-field map-name="getInventoryResults" field-name="availableToPromise" to-map-name="alertResult" />
                <field-to-list field-name="alertResult" list-name="alertResults" />
            </if-compare-field>
        </iterate>
        <field-to-result result-name="alertResults" field-name="alertResults" />
        <field-to-request field-name="alertResults" request-name="alertResults" />
    </simple-method>
    
    <simple-method method-name="emailInventoryAlerts" short-description="Email Inventory Alerts" login-required="false">
        <field-to-field map-name="parameters" field-name="catalogId" to-map-name="urlParams" />
        <field-to-field field-name="urlParams" to-map-name="emailParams" to-field-name="bodyUrlParameters" />
        <string-to-field string="mail.smtp.host" field-name="sendType" map-name="emailParams" />
        
        <property-to-field resource="inventoryalerts" property="mailhost" field-name="sendVia" map-name="emailParams"/>
        <property-to-field resource="inventoryalerts" property="sendTo" field-name="sendTo" map-name="emailParams"/>
        <property-to-field resource="inventoryalerts" property="sendFrom" field-name="sendFrom" map-name="emailParams"/>
        <property-to-field resource="inventoryalerts" property="subject" field-name="subject" map-name="emailParams"/>
        <property-to-field resource="inventoryalerts" property="bodyUrl" field-name="bodyUrl" map-name="emailParams"/>
        <call-service service-name="getInventoryAlerts" in-map-name="parameters" >
            <result-to-field result-name="alertResults" map-name="getInventoryResults" />
        </call-service>
        <if-not-empty map-name="getInventoryResults" field-name="alertResults">
            <call-service service-name="sendMailFromUrl" in-map-name="emailParams"/>
        </if-not-empty>
    </simple-method>
        
    <simple-method method-name="reserveProductInventory" short-description="Reserve Inventory for a Product">
        <!--
            this method can be called with some optional parameters:
                -facilityId
                -containerId
            If the service definitions are used then only one of these two will ever be specified, or neither of them.

            Whatever it is called with, it will basicly get a list of InventoryItems and reserve the first available inventory.

            If requireInventory is Y the quantity not reserved is returned, if N then a negative
            availableToPromise will be used to track quantity ordered beyond what is in stock.
        -->

        <log level="verbose" message="Parameters : ${parameters}"/>
        <field-to-field field-name="productId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <field-to-field field-name="facilityId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <field-to-field field-name="containerId" map-name="parameters" to-map-name="lookupFieldMap"/>
        <now-timestamp-to-env env-name="nowTimestamp"/>
        
        <make-value entity-name="OrderHeader" value-name="ohLookupMap"/>
        <set-pk-fields map-name="parameters" value-name="ohLookupMap"/>
        <find-by-primary-key entity-name="OrderHeader" map-name="ohLookupMap" value-name="orderHeader"/>        

        <!-- before we do the find, put together the orderBy list based on which reserveOrderEnumId is specified -->
        <if-compare value="INVRO_FIFO_EXP" operator="equals" field-name="reserveOrderEnumId" map-name="parameters">
            <string-to-field string="+expireDate" field-name="orderByString"/>
        <else>
            <if-compare value="INVRO_LIFO_EXP" operator="equals" field-name="reserveOrderEnumId" map-name="parameters">
                <string-to-field string="-expireDate" field-name="orderByString"/>
            <else>
                <if-compare value="INVRO_LIFO_REC" operator="equals" field-name="reserveOrderEnumId" map-name="parameters">
                    <string-to-field string="+dateReceived" field-name="orderByString"/>
                <else>
                    <!-- the default reserveOrderEnumId is INVRO_FIFO_REC, ie FIFO based on date received -->
                    <string-to-field string="-dateReceived" field-name="orderByString"/>
                    <string-to-field string="INVRO_FIFO_REC" field-name="reserveOrderEnumId" map-name="parameters"/>
                </else>
                </if-compare>
            </else>
            </if-compare>
        </else>
        </if-compare>
        <field-to-list field-name="orderByString" list-name="orderByList"/>

        <find-by-and entity-name="InventoryItem" map-name="lookupFieldMap" list-name="inventoryItems" order-by-list-name="orderByList"/>

        <field-to-field field-name="quantity" map-name="parameters" to-field-name="quantityNotReserved"/>
        <iterate entry-name="inventoryItem" list-name="inventoryItems">
            <!-- only do something with this inventoryItem if there is more inventory to reserve -->
            <if-compare field-name="quantityNotReserved" map-name="parameters" type="Double" operator="greater" value="0.0">
            	<!-- get the promiseDatetime -->           	
            	<get-related-one value-name="inventoryItem" relation-name="ProductFacility" to-value-name="productFacility"/>
            	<field-to-env env-name="daysToShip" field-name="daysToShip" map-name="productFacility"/>
            	<if-empty field-name="daysToShip">
            		<calculate field-name="daysToShip" type="Long">
            	    	<number value="30"/>
            	    </calculate>           		
            	</if-empty>
            	<call-bsh><![CDATA[
            	java.sql.Timestamp orderDate = orderHeader.getTimestamp("orderDate");
            	java.util.Calendar cal = java.util.Calendar.getInstance();
            	cal.setTimeInMillis(orderDate.getTime());
            	cal.add(java.util.Calendar.DAY_OF_YEAR, daysToShip.intValue());
            	return org.ofbiz.base.util.UtilMisc.toMap("promisedDatetime", new java.sql.Timestamp(cal.getTimeInMillis()));            	
            	]]></call-bsh>
            	
                <if-compare value="SERIALIZED_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
                    <if-compare value="INV_AVAILABLE" operator="equals" field-name="statusId" map-name="inventoryItem">
                        <!-- change status on inventoryItem -->
                        <string-to-field string="INV_PROMISED" field-name="statusId" map-name="inventoryItem"/>
                        <store-value value-name="inventoryItem"/>

                        <!-- store OrderItemInventoryRes record -->
                        <field-to-field field-name="orderId" map-name="parameters" to-map-name="reserveOiiMap"/>
                        <field-to-field field-name="orderItemSeqId" map-name="parameters" to-map-name="reserveOiiMap"/>
                        <field-to-field field-name="inventoryItemId" map-name="inventoryItem" to-map-name="reserveOiiMap"/>
                        <field-to-field field-name="reserveOrderEnumId" map-name="parameters" to-map-name="reserveOiiMap"/>
                        <field-to-field field-name="reservedDatetime" map-name="parameters" to-map-name="reserveOiiMap"/>
                        <env-to-field env-name="promisedDatetime" field-name="promisedDatetime" map-name="reserveOiiMap"/>
                        <calculate field-name="quantity" map-name="reserveOiiMap"><number value="1"/></calculate>
                        <call-service service-name="reserveOrderItemInventory" in-map-name="reserveOiiMap"/>
                        <clear-field field-name="reserveOiiMap"/>

                        <calculate field-name="quantityNotReserved" map-name="parameters">
                            <calcop operator="subtract" field-name="quantityNotReserved" map-name="parameters">
                                <number value="1.0"/>
                            </calcop>
                        </calculate>
                    </if-compare>
                </if-compare>
                <if-compare value="NON_SERIAL_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
                    <if-not-empty field-name="availableToPromise" map-name="inventoryItem">
                        <!-- reduce atp on inventoryItem if availableToPromise greater than 0, if not the code at the end of this method will handle it -->
                        <if-compare field-name="availableToPromise" map-name="inventoryItem" operator="greater" value="0.0" type="Double">
                            <if-compare-field field-name="quantityNotReserved" map-name="parameters" operator="greater" type="Double"
                                    to-field-name="availableToPromise" to-map-name="inventoryItem">
                                <field-to-field field-name="availableToPromise" map-name="inventoryItem" to-field-name="deductAmount" to-map-name="parameters"/>
                                <else>
                                    <field-to-field field-name="quantityNotReserved" map-name="parameters" to-field-name="deductAmount" to-map-name="parameters"/>
                                </else>
                            </if-compare-field>
                            <calculate field-name="availableToPromise" map-name="inventoryItem">
                                <calcop operator="subtract" field-name="availableToPromise" map-name="inventoryItem">
                                    <calcop operator="get" field-name="deductAmount" map-name="parameters"/>
                                </calcop>
                            </calculate>
                            <store-value value-name="inventoryItem"/>

                            <!-- create OrderItemInventoryRes record -->
                            <field-to-field field-name="orderId" map-name="parameters" to-map-name="reserveOiiMap"/>
                            <field-to-field field-name="orderItemSeqId" map-name="parameters" to-map-name="reserveOiiMap"/>
                            <field-to-field field-name="inventoryItemId" map-name="inventoryItem" to-map-name="reserveOiiMap"/>
                            <field-to-field field-name="reserveOrderEnumId" map-name="parameters" to-map-name="reserveOiiMap"/>
                            <field-to-field field-name="reservedDatetime" map-name="parameters" to-map-name="reserveOiiMap"/>
                            <field-to-field field-name="deductAmount" map-name="parameters" to-field-name="quantity" to-map-name="reserveOiiMap"/>
                            <env-to-field env-name="promisedDatetime" field-name="promisedDatetime" map-name="reserveOiiMap"/>
                            <call-service service-name="reserveOrderItemInventory" in-map-name="reserveOiiMap"/>
                            <clear-field field-name="reserveOiiMap"/>

                            <calculate field-name="quantityNotReserved" map-name="parameters">
                                <calcop operator="subtract" field-name="quantityNotReserved" map-name="parameters">
                                    <calcop operator="get" field-name="deductAmount" map-name="parameters"/>
                                </calcop>
                            </calculate>
                        </if-compare>
                    </if-not-empty>

                    <!-- keep track of the last non-serialized inventory item for use if inventory is not required for purchase -->
                    <!-- use env variable named lastNonSerInventoryItem -->
                    <env-to-field env-name="inventoryItem" field-name="lastNonSerInventoryItem"/>
                </if-compare>
            </if-compare>
        </iterate>

        <!--
            if inventory is not required for purchase and quantityNotReserved != 0:
                - subtract the remaining quantityNotReserved from the availableToPromise of the last non-serialized inventory item
                - or if none was found create a non-ser InventoryItem with availableToPromise = -quantityNotReserved
        -->
        <if-compare value="0.0" operator="not-equals" field-name="quantityNotReserved" map-name="parameters" type="Double">
            <if-compare value="Y" operator="equals" field-name="requireInventory" map-name="parameters">
                <!-- use this else pattern to accomplish the anything but Y logic, ie if not specified default to inventory NOT required -->
            <else>
                <if-not-empty field-name="lastNonSerInventoryItem">
                    <!-- subtract from quantityNotReserved from the availableToPromise of existing inventory item -->
                    <calculate field-name="availableToPromise" map-name="lastNonSerInventoryItem">
                        <calcop operator="subtract" field-name="availableToPromise" map-name="lastNonSerInventoryItem">
                            <calcop operator="get" field-name="quantityNotReserved" map-name="parameters"/>
                        </calcop>
                    </calculate>
                    <store-value value-name="lastNonSerInventoryItem"/>
                    
           	        <!-- get the promiseDatetime -->           	
            		<get-related-one value-name="lastNonSerInventoryItem" relation-name="ProductFacility" to-value-name="productFacility"/>
            		<field-to-env env-name="daysToShip" field-name="daysToShip" map-name="productFacility"/>
            		<if-empty field-name="daysToShip">
            			<calculate field-name="daysToShip" type="Long">
            	    		<number value="30"/>
            	    	</calculate>           		
            		</if-empty>
            		<call-bsh><![CDATA[
            		java.sql.Timestamp orderDate = orderHeader.getTimestamp("orderDate");
            		java.util.Calendar cal = java.util.Calendar.getInstance();
            		cal.setTimeInMillis(orderDate.getTime());
            		cal.add(java.util.Calendar.DAY_OF_YEAR, daysToShip.intValue());
            		return org.ofbiz.base.util.UtilMisc.toMap("promisedDatetime", new java.sql.Timestamp(cal.getTimeInMillis()));            	
            		]]></call-bsh>                                        

                    <!-- create or update OrderItemInventoryRes record -->
                    <field-to-field field-name="orderId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="orderItemSeqId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="inventoryItemId" map-name="lastNonSerInventoryItem" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="reserveOrderEnumId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="quantityNotReserved" map-name="parameters" to-field-name="quantity" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="reservedDatetime" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <env-to-field env-name="promisedDatetime" field-name="promisedDatetime" map-name="reserveOiiMap"/>
                    <call-service service-name="reserveOrderItemInventory" in-map-name="reserveOiiMap"/>
                    <clear-field field-name="reserveOiiMap"/>
                <else>
                    <!-- no non-ser inv item, create a non-ser InventoryItem with availableToPromise = -quantityNotReserved -->
                    <make-value entity-name="InventoryItem" value-name="newNonSerInventoryItem"/>
                    <sequenced-id-to-env sequence-name="InventoryItem" env-name="inventoryItemId"/>
                    <to-string field-name="inventoryItemId"/>
                    <env-to-field env-name="inventoryItemId" map-name="newNonSerInventoryItem"/>

                    <field-to-field field-name="productId" map-name="parameters" to-map-name="newNonSerInventoryItem"/>
                    <field-to-field field-name="facilityId" map-name="parameters" to-map-name="newNonSerInventoryItem"/>
                    <field-to-field field-name="containerId" map-name="parameters" to-map-name="newNonSerInventoryItem"/>
                    <string-to-field string="NON_SERIAL_INV_ITEM" field-name="inventoryItemTypeId" map-name="newNonSerInventoryItem"/>
                    <calculate field-name="availableToPromise" map-name="newNonSerInventoryItem">
                        <calcop operator="negative" field-name="quantityNotReserved" map-name="parameters"/>
                    </calculate>
                    <create-value value-name="newNonSerInventoryItem"/>
                    
           	        <!-- get the promiseDatetime -->           	
            		<get-related-one value-name="newNonSerInventoryItem" relation-name="ProductFacility" to-value-name="productFacility"/>
            		<field-to-env field-name="daysToShip" map-name="productFacility" env-name="daysToShip"/>
            		<if-empty field-name="daysToShip">
            			<calculate field-name="daysToShip" type="Long"><number value="30"/></calculate>           		
            		</if-empty>
            		<call-bsh><![CDATA[
            		java.sql.Timestamp orderDate = orderHeader.getTimestamp("orderDate");
            		java.util.Calendar cal = java.util.Calendar.getInstance();
            		cal.setTimeInMillis(orderDate.getTime());
            		cal.add(java.util.Calendar.DAY_OF_YEAR, daysToShip.intValue());
            		return org.ofbiz.base.util.UtilMisc.toMap("promisedDatetime", new java.sql.Timestamp(cal.getTimeInMillis()));            	
            		]]></call-bsh>                                        
                                     
                    <!-- create OrderItemInventoryRes record -->
                    <field-to-field field-name="orderId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="orderItemSeqId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="inventoryItemId" map-name="newNonSerInventoryItem" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="reserveOrderEnumId" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="quantityNotReserved" map-name="parameters" to-field-name="quantity" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="quantityNotReserved" map-name="parameters" to-field-name="quantityNotAvailable" to-map-name="reserveOiiMap"/>
                    <field-to-field field-name="reservedDatetime" map-name="parameters" to-map-name="reserveOiiMap"/>
                    <env-to-field env-name="promisedDatetime" field-name="promisedDatetime" map-name="reserveOiiMap"/>
                    <call-service service-name="reserveOrderItemInventory" in-map-name="reserveOiiMap"/>
                    <clear-field field-name="reserveOiiMap"/>
                </else>
                </if-not-empty>

                <calculate field-name="quantityNotReserved" map-name="parameters"><number value="0"/></calculate>
            </else>
            </if-compare>
        </if-compare>

        <field-to-result field-name="quantityNotReserved" map-name="parameters"/>
    </simple-method>

    <simple-method method-name="reserveOrderItemInventory" short-description="Reserve Order Item Inventory">
        <make-value entity-name="OrderItemInventoryRes" value-name="newOiirEntity"/>
        <set-pk-fields map-name="parameters" value-name="newOiirEntity"/>
        <find-by-primary-key map-name="newOiirEntity" value-name="checkOiirEntity"/>
        <if-empty field-name="checkOiirEntity">
            <!-- create OrderItemInventoryRes record -->
            <set-nonpk-fields map-name="parameters" value-name="newOiirEntity"/>
            <now-timestamp-to-env env-name="nowTimestamp"/>
            <env-to-field env-name="nowTimestamp" field-name="createdDatetime" map-name="newOiirEntity"/>
            <if-empty field-name="reservedDatetime" map-name="newOiirEntity">
                <env-to-field env-name="nowTimestamp" field-name="reservedDatetime" map-name="newOiirEntity"/>
            </if-empty>
            <create-value value-name="newOiirEntity"/>
        <else>
            <calculate field-name="quantity" map-name="checkOiirEntity">
                <calcop operator="add" field-name="quantity" map-name="checkOiirEntity">
                    <calcop operator="get" field-name="quantity" map-name="parameters"/>
                </calcop>
            </calculate>
            <calculate field-name="quantityNotAvailable" map-name="checkOiirEntity">
                <calcop operator="add" field-name="quantityNotAvailable" map-name="checkOiirEntity">
                    <calcop operator="get" field-name="quantityNotAvailable" map-name="parameters"/>
                </calcop>
            </calculate>
            <store-value value-name="checkOiirEntity"/>
        </else>
        </if-empty>
    </simple-method>
    
    <simple-method method-name="cancelOrderInventoryReservation" short-description="Cancel Inventory Reservation for an Order">
        <!--
            Iterates through each OrderItemInventoryRes on each OrderItem for the order
            with the given orderId and cancels the reservation by removing the
            OrderItemInventoryRes and incrementing the corresponding non-serialized
            inventoryItem's availableToPromise quantity, or setting the status of the 
            corresponding serialized inventoryItem to available.
        -->
        <field-to-field field-name="orderId" map-name="parameters" to-map-name="oiirListLookupMap"/>
        <if-not-empty field-name="orderItemSeqId" map-name="parameters">        	
        	<field-to-field field-name="orderItemSeqId" map-name="parameters" to-map-name="oiirListLookupMap"/>
        	<log level="verbose" message="OIIR Cancel for single item : ${oiirListLookupMap}"/>
        </if-not-empty>
        <find-by-and entity-name="OrderItemInventoryRes" map-name="oiirListLookupMap" list-name="oiirList" use-cache="false"/>
        <iterate entry-name="oiir" list-name="oiirList">
        	<field-to-field field-name="orderId" map-name="oiir" to-map-name="cancelOiirMap"/>
   			<field-to-field field-name="orderItemSeqId" map-name="oiir" to-map-name="cancelOiirMap"/>
   			<field-to-field field-name="inventoryItemId" map-name="oiir" to-map-name="cancelOiirMap"/>
            <call-service service-name="cancelOrderItemInventoryRes" in-map-name="cancelOiirMap"/>
        </iterate>
    </simple-method>
    <simple-method method-name="cancelOrderItemInventoryRes" short-description="Cancel An Inventory Reservation">
        <make-value value-name="lookupPKMap" entity-name="OrderItemInventoryRes"/>
        <set-pk-fields map-name="parameters" value-name="lookupPKMap"/>
        <find-by-primary-key entity-name="OrderItemInventoryRes" map-name="lookupPKMap" value-name="orderItemInventoryRes"/>

        <get-related-one relation-name="InventoryItem" value-name="orderItemInventoryRes" to-value-name="inventoryItem"/>        
        <if-compare value="SERIALIZED_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
            <log level="verbose" message="Serialized inventory re-enabled."/>
            <string-to-field string="INV_AVAILABLE" field-name="statusId" map-name="inventoryItem"/>
        </if-compare>
        <if-compare value="NON_SERIAL_INV_ITEM" operator="equals" field-name="inventoryItemTypeId" map-name="inventoryItem">
            <log level="verbose" message="Non-Serialized inventory item incrementing availableToPromise."/>
            <calculate field-name="availableToPromise" map-name="inventoryItem">
                <calcop operator="add" field-name="availableToPromise" map-name="inventoryItem">
                    <calcop operator="get" field-name="quantity" map-name="orderItemInventoryRes"/>
                </calcop>
            </calculate>
        </if-compare>
        <store-value value-name="inventoryItem"/>
        <remove-value value-name="orderItemInventoryRes"/>
    </simple-method>
    
    <simple-method method-name="balanceInventoryItems" short-description="Balances available-to-promise on inventory items">
    	<make-value entity-name="InventoryItem" value-name="lookupPKMap"/>
    	<set-pk-fields value-name="lookupPKMap" map-name="parameters"/>
    	<find-by-primary-key entity-name="InventoryItem" map-name="lookupPKMap" value-name="inventoryItem"/>
    	<if-compare field-name="inventoryItemTypeId" map-name="inventoryItem" operator="equals" value="NON_SERIAL_INV_ITEM">    	
	    	<!-- now find all items related by product/facility -->
   		 	<field-to-field field-name="facilityId" map-name="inventoryItem" to-map-name="lookupMap"/>
    		<field-to-field field-name="productId" map-name="inventoryItem" to-map-name="lookupMap"/>
    		<string-to-field field-name="inventoryItemTypeId" map-name="lookupMap" string="NON_SERIAL_INV_ITEM"/>
    		<find-by-and entity-name="InventoryItem" map-name="lookupMap" list-name="inventoryItems"/>    	
    	
    		<!-- find all items which have a negative ATP; find their current reservations -->    	
    		<iterate list-name="inventoryItems" entry-name="item">    		
    			<if-compare field-name="availableToPromise" map-name="item" operator="less" value="0">
    				<get-related value-name="item" relation-name="OrderItemInventoryRes" list-name="relatedRes"/>
    				<list-to-list list-name="relatedRes" to-list-name="reservations"/>
    			</if-compare>
    		</iterate>
    	
   		 	<!-- sort the list by date -->    	
    		<order-value-list list-name="reservations" order-by-list-name="reservedDatetime"/>
    	    	
    		<iterate list-name="reservations" entry-name="oiir">
    			<!-- cancel the reservation -->
   				<field-to-field field-name="orderId" map-name="oiir" to-map-name="cancelOiirMap"/>
   				<field-to-field field-name="orderItemSeqId" map-name="oiir" to-map-name="cancelOiirMap"/>
   				<field-to-field field-name="inventoryItemId" map-name="oiir" to-map-name="cancelOiirMap"/>   			
           	 	<call-service service-name="cancelOrderItemInventoryRes" in-map-name="cancelOiirMap"/>
            	<clear-field field-name="cancelOiirMap"/>

   				<!-- re-reserve the cancelled item -->
    			<!-- require inventory is N because it had to be N to begin with to have a negative ATP -->
    			<field-to-field field-name="productId" map-name="inventoryItem" to-map-name="resMap"/>
    			<field-to-field field-name="orderId" map-name="oiir" to-map-name="resMap"/>
    			<field-to-field field-name="orderItemSeqId" map-name="oiir" to-map-name="resMap"/>
    			<field-to-field field-name="quantity" map-name="oiir" to-map-name="resMap"/>
    			<field-to-field field-name="reservedDatetime" map-name="oiir" to-map-name="resMap"/>
    			<field-to-field field-name="reserveOrderEnumId" map-name="oiir" to-map-name="resMap"/>
    			<string-to-field field-name="requireInventory" map-name="resMap" string="N"/>    		
    			<call-service service-name="reserveProductInventory" in-map-name="resMap"/>
    			<clear-field field-name="resMap"/>
    		</iterate>
    	</if-compare>
    </simple-method>
    
    <!-- Inventory Transfer Services -->
    <simple-method method-name="createInventoryTransfer" short-description="Create an Inventory Transfer">
        <check-permission permission="FACILITY" action="_CREATE"><fail-message message="Security Error: to run createInventoryTransfer you must have the FACILITY_CREATE or FACILITY_ADMIN permission"/></check-permission>
        <check-errors/>

        <make-value value-name="newEntity" entity-name="InventoryTransfer"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        
        <sequenced-id-to-env sequence-name="InventoryTransfer" env-name="inventoryTransferId"/>
        <to-string field-name="inventoryTransferId"/>
        <env-to-field env-name="inventoryTransferId" map-name="newEntity"/>
        <field-to-result field-name="inventoryTransferId" result-name="inventoryTransferId"/>
        
        <create-value value-name="newEntity"/>
    </simple-method>
    <simple-method method-name="updateInventoryTransfer" short-description="Update an Inventory Transfer">
        <check-permission permission="FACILITY" action="_UPDATE"><fail-message message="Security Error: to run updateInventoryTransfer you must have the FACILITY_UPDATE or FACILITY_ADMIN permission"/></check-permission>
        <check-errors/>

        <field-to-field field-name="inventoryTransferId" map-name="parameters" to-map-name="lookupPKMap"/>
        <find-by-primary-key entity-name="InventoryTransfer" map-name="lookupPKMap" value-name="inventoryTransfer"/>
        <set-nonpk-fields map-name="parameters" value-name="inventoryTransfer"/>
        <store-value value-name="inventoryTransfer"/>
    </simple-method>    
</simple-methods>
