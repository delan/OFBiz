<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE service-eca PUBLIC "-//OFBiz//DTD Service ECA Config//EN" "http://www.ofbiz.org/dtds/service-eca.dtd">

<service-eca>	
	<!-- if new statusId is SHIPMENT_PACKED, create invoice -->
	<eca service="updateShipment" event="commit">
        <condition-field field-name="statusId" operator="not-equals" to-field-name="oldStatusId"/>
		<condition field-name="statusId" operator="equals" value="SHIPMENT_PACKED"/>
		<action service="createInvoicesFromShipment" mode="sync"/>
	</eca>

	<!-- if new statusId is SHIPMENT_SCHEDULED, send notification -->
	<eca service="createShipment" event="commit">
		<condition field-name="statusId" operator="equals" value="SHIPMENT_SCHEDULED"/>
		<action service="sendShipmentScheduledNotification" mode="async"/>
	</eca>
	<eca service="updateShipment" event="commit">
        <condition-field field-name="statusId" operator="not-equals" to-field-name="oldStatusId"/>
		<condition field-name="statusId" operator="equals" value="SHIPMENT_SCHEDULED"/>
		<action service="sendShipmentScheduledNotification" mode="async"/>
	</eca>

	<!-- if new originFacilityId or destinationFacilityId, get settings from facilities -->
	<eca service="createShipment" event="commit">
		<condition field-name="originFacilityId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromFacilities" mode="sync"/>
	</eca>
	<eca service="createShipment" event="commit">
		<condition field-name="destinationFacilityId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromFacilities" mode="sync"/>
	</eca>
	<eca service="updateShipment" event="commit">
        <condition-field field-name="originFacilityId" operator="not-equals" to-field-name="oldOriginFacilityId"/>
		<condition field-name="originFacilityId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromFacilities" mode="sync"/>
	</eca>
	<eca service="updateShipment" event="commit">
        <condition-field field-name="destinationFacilityId" operator="not-equals" to-field-name="oldDestinationFacilityId"/>
		<condition field-name="destinationFacilityId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromFacilities" mode="sync"/>
	</eca>
	
	<!-- if new primaryOrderId, get settings from order -->
	<eca service="createShipment" event="commit">
		<condition field-name="primaryOrderId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromPrimaryOrder" mode="sync"/>
	</eca>
	<eca service="updateShipment" event="commit">
        <condition-field field-name="primaryOrderId" operator="not-equals" to-field-name="oldPrimaryOrderId"/>
		<condition field-name="primaryOrderId" operator="is-not-empty"/>
		<action service="setShipmentSettingsFromPrimaryOrder" mode="sync"/>
	</eca>

    <eca service="createShipmentReceipt" event="commit">
        <condition field-name="returnId" operator="is-not-empty"/>
        <action service="updateReturnStatusFromReceipt" mode="sync"/>
    </eca>
    <eca service="createShipmentReceipt" event="commit">
        <condition field-name="orderId" operator="is-not-empty"/>
        <action service="updateOrderStatusFromReceipt" mode="sync"/>
    </eca>

    <eca service="createShipmentPackageContent" event="in-validate">
        <condition field-name="shipmentPackageSeqId" operator="equals" value="New"/>
        <action service="createShipmentPackage" mode="sync"/>
    </eca>
</service-eca>
