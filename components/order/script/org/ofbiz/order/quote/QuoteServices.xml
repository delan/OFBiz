<?xml version="1.0" encoding="UTF-8" ?>
<!--
 * Copyright (c) 2001-2004 The Open For Business Project and repective authors.
 * Permission is hereby granted, free of charge, to any person obtaining a
 *  copy of this software and associated documentation files (the "Software"),
 *  to deal in the Software without restriction, including without limitation
 *  the rights to use, copy, modify, merge, publish, distribute, sublicense,
 *  and/or sell copies of the Software, and to permit persons to whom the
 *  Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included
 *  in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 *  OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 *  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 *  CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT
 *  OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR
 *  THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * @author <a href="mailto:tiz@sastau.it">Jacopo Cappellato</a>
 * @version 1.0
 -->

<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xsi:noNamespaceSchemaLocation="http://www.ofbiz.org/dtds/simple-methods.xsd">

    <!-- ================================================================ -->
    <!-- Quote Services -->
    <!-- ================================================================ -->
    
    <!-- create a new Quote -->
    <simple-method method-name="createQuote" short-description="Create a Quote">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run createQuote you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <!-- create new entity and create all the fields -->
        <make-value value-name="newEntity" entity-name="Quote"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>

        <!-- create a non existing ID -->
        <sequenced-id-to-env sequence-name="Quote" env-name="quoteId"/>
        <env-to-field env-name="quoteId" map-name="newEntity"/>
        <field-to-result field-name="quoteId" result-name="quoteId"/>

        <!-- finally create the record (should not exist already)-->
        <create-value value-name="newEntity"/>
        <check-errors/>
    </simple-method>

    <!-- update an existing Quote -->
    <simple-method method-name="updateQuote" short-description="Update an existing Quote">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run updateQuote you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="Quote" value-name="quote" auto-field-map="true"/>
        <check-errors/>
        <set-nonpk-fields map-name="parameters" value-name="quote"/>
        <store-value value-name="quote"/>
        <check-errors/>
    </simple-method>

    <!-- create a new QuoteItem -->
    <simple-method method-name="createQuoteItem" short-description="Create a QuoteItem">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run createQuoteItem you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <!-- create new entity and create all the fields -->
        <make-value value-name="newEntity" entity-name="QuoteItem"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>

        <!-- create a non existing ID -->
        <make-next-seq-id value-name="newEntity" seq-field-name="quoteItemSeqId"/>
        <field-to-field field-name="parameters.quoteId" to-field-name="newEntity.quoteId"/>
        <env-to-field env-name="quoteItemSeqId" map-name="newEntity"/>
        <field-to-result field-name="quoteId" result-name="quoteId"/>
        <field-to-result field-name="quoteItemSeqId" result-name="quoteItemSeqId"/>

        <!-- finally create the record (should not exist already)-->
        <create-value value-name="newEntity"/>
        <check-errors/>
    </simple-method>

    <!-- update an existing QuoteItem -->
    <simple-method method-name="updateQuoteItem" short-description="Update an existing QuoteItem">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run updateQuoteItem you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="QuoteItem" value-name="quoteItem" auto-field-map="true"/>
        <check-errors/>
        <set-nonpk-fields map-name="parameters" value-name="quoteItem"/>
        <store-value value-name="quoteItem"/>
        <check-errors/>
    </simple-method>

    <!-- remove an quoteItem -->
    <simple-method method-name="removeQuoteItem" short-description="Remove a QuoteItem">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run removeQuoteItem you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="QuoteItem" value-name="quoteItem" auto-field-map="true"/>
        <check-errors/>
        <remove-value value-name="quoteItem"/>
    </simple-method>

    <!-- create a new QuoteAttribute -->
    <simple-method method-name="createQuoteAttribute" short-description="Create a QuoteAttribute">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run createQuoteAttribute you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <!-- create new entity and create all the fields -->
        <make-value value-name="newEntity" entity-name="QuoteAttribute"/>
        <set-pk-fields map-name="parameters" value-name="newEntity"/>
        <set-nonpk-fields map-name="parameters" value-name="newEntity"/>
        <create-value value-name="newEntity"/>
        <check-errors/>
    </simple-method>

    <!-- update an existing QuoteAttribute -->
    <simple-method method-name="updateQuoteAttribute" short-description="Update an existing QuoteAttribute">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run updateQuoteAttribute you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="QuoteAttribute" value-name="quoteAttribute" auto-field-map="true"/>
        <check-errors/>
        <set-nonpk-fields map-name="parameters" value-name="quoteAttribute"/>
        <store-value value-name="quoteAttribute"/>
        <check-errors/>
    </simple-method>

    <!-- remove an existing QuoteAttribute -->
    <simple-method method-name="removeQuoteAttribute" short-description="Remove an existing QuoteAttribute">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run removeQuoteAttribute you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="QuoteAttribute" value-name="quoteAttribute" auto-field-map="true"/>
        <check-errors/>
        <remove-value value-name="quoteAttribute"/>
        <check-errors/>
    </simple-method>
    
    <!-- create a new Quote and QuoteItem for a given CustRequest -->
    <simple-method method-name="createQuoteAndQuoteItemForRequest" short-description="Create a Quote">
        <check-permission permission="ORDERMGR" action="_CREATE">
            <fail-message message="Security Error: to run createQuoteAndQuoteItemForRequest you must have the ORDERMGR_CREATE or ORDERMGR_ADMIN permission"/>
        </check-permission>
        <check-errors/>
        <entity-one entity-name="CustRequest" value-name="custRequest" auto-field-map="true"/>
        <make-value value-name="lookupRequestRole" entity-name="CustRequestRole"/>
        <field-to-field field-name="parameters.custRequestId" to-field-name="lookupRequestRole.custRequestId"/>
        <string-to-field string="REQ_REQUESTER" field-name="lookupRequestRole.roleTypeId"/>
        <find-by-and entity-name="CustRequestRole" map-name="lookupRequestRole" list-name="roles"/>
        <first-from-list entry-name="requester" list-name="roles"/>
        
        <if-empty field-name="custRequest">
            <add-error>
                <fail-message message="Error: CustRequest with id [${custRequestId}] doesn't exist."/>
            </add-error>
        </if-empty>
        <check-errors/>
        <!-- create new entity and create all the fields -->
        <make-value value-name="newQuote" entity-name="Quote"/>
        <make-value value-name="newQuoteItem" entity-name="QuoteItem"/>
        <set-nonpk-fields map-name="parameters" value-name="newQuote"/>
        <set-nonpk-fields map-name="parameters" value-name="newQuoteItem"/>
        
        <!-- create a non existing ID -->
        <sequenced-id-to-env sequence-name="Quote" env-name="quoteId"/>
        <make-next-seq-id value-name="newQuoteItem" seq-field-name="quoteItemSeqId"/>
        <env-to-field env-name="quoteId" map-name="newQuote"/>
        <env-to-field env-name="quoteId" map-name="newQuoteItem"/>
        <field-to-result field-name="quoteId" result-name="quoteId"/>
        <field-to-result field-name="newQuoteItem.quoteItemSeqId" result-name="quoteItemSeqId"/>
        
        <field-to-field field-name="requester.partyId" to-field-name="newQuote.partyId"/>
        <!-- finally create the records -->
        <create-value value-name="newQuote"/>
        <create-value value-name="newQuoteItem"/>
        <if-not-empty field-name="parameters.attrName">
            <make-value value-name="newQuoteAttribute" entity-name="QuoteAttribute"/>
            <env-to-field env-name="quoteId" map-name="newQuoteAttribute"/>
            <field-to-field field-name="parameters.attrName" to-field-name="newQuoteAttribute.attrName"/>
            <field-to-field field-name="parameters.attrValue" to-field-name="newQuoteAttribute.attrValue"/>
            <create-value value-name="newQuoteAttribute"/>
        </if-not-empty>
        <check-errors/>
    </simple-method>

</simple-methods>