<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE service-eca PUBLIC "-//OFBiz//DTD Service ECA Config//EN" "http://www.ofbiz.org/dtds/service-eca.dtd">

<service-eca>
    <!-- order item status changes -->
    <eca service="storeOrder" event="return">
        <action service="resetGrandTotal" mode="sync"/>
    </eca>
    <eca service="changeOrderItemStatus" event="commit">
        <condition field-name="statusId" operator="equals" value="ITEM_CANCELLED"/>
        <action service="cancelOrderInventoryReservation" mode="sync"/>
        <action service="recalcShippingTotal" mode="sync"/>
        <action service="recalcTaxTotal" mode="sync"/>
        <action service="resetGrandTotal" mode="sync"/>
        <action service="checkOrderItemStatus" mode="sync"/>
        <action service="sendOrderChangeNotification" mode="async" persist="true"/>
    </eca>
    <eca service="changeOrderItemStatus" event="commit">
        <condition field-name="statusId" operator="equals" value="ITEM_COMPLETED"/>
        <action service="checkOrderItemStatus" mode="sync"/>
    </eca>
    <eca service="changeOrderItemStatus" event="commit">
        <condition field-name="statusId" operator="equals" value="ITEM_APPROVED"/>
        <action service="checkOrderItemStatus" mode="sync"/>
    </eca>

    <!-- order status changes -->
    <eca service="changeOrderStatus" event="commit" run-on-error="false">
        <condition field-name="statusId" operator="equals" value="ORDER_CANCELLED"/>
        <action service="releaseOrderPayments" mode="sync"/>
    </eca>
    <eca service="changeOrderStatus" event="commit" run-on-error="false">
        <condition field-name="statusId" operator="equals" value="ORDER_COMPLETED"/>
        <action service="resetGrandTotal" mode="sync"/>
        <action service="sendOrderCompleteNotification" mode="async" persist="true"/>
    </eca>
    <eca service="changeOrderStatus" event="commit" run-on-error="false">
        <condition field-name="statusId" operator="equals" value="ORDER_PROCESSING"/>
        <action service="processOrderWf" mode="async" persist="true" />
    </eca>

    <!-- create adjustment change -->
    <eca service="createOrderAdjustment" event="commit">
        <action service="resetGrandTotal" mode="sync"/>
    </eca>

    <!-- order confirmation/notification email ECAs -->
    <eca service="sendOrderConfirmation" event="in-validate">
    	<action service="prepareOrderConfirmation" mode="sync" result-to-context="true"/>
    	<action service="prepareOrderEmailData" mode="sync" result-to-context="false" result-map-name="templateData"/>
    </eca>
    <eca service="sendOrderConfirmation" event="commit">
    	<action service="createOrderNotificationLog" mode="sync"/>
    </eca>
    <eca service="sendOrderChangeNotification" event="in-validate">
    	<action service="prepareOrderChange" mode="sync" result-to-context="true"/>
    	<action service="prepareOrderEmailData" mode="sync" result-to-context="false" result-map-name="templateData"/>
    </eca>
    <eca service="sendOrderChangeNotification" event="commit">
    	<action service="createOrderNotificationLog" mode="sync"/>
    </eca>
    <eca service="sendOrderCompleteNotification" event="in-validate">
    	<action service="prepareOrderComplete" mode="sync" result-to-context="true"/>
    	<action service="prepareOrderEmailData" mode="sync" result-to-context="false" result-map-name="templateData"/>
    </eca>
    <eca service="sendOrderCompleteNotification" event="commit">
    	<action service="createOrderNotificationLog" mode="sync"/>
    </eca>
    <eca service="sendOrderBackorderNotification" event="in-validate">
    	<action service="prepareOrderBackorder" mode="sync" result-to-context="true"/>
    	<action service="prepareOrderEmailData" mode="sync" result-to-context="false" result-map-name="templateData"/>
    </eca>
    <eca service="sendOrderBackorderNotification" event="commit">
    	<action service="createOrderNotificationLog" mode="sync"/>
    </eca>
    <eca service="sendOrderPayRetryNotification" event="in-validate">
    	<action service="prepareOrderPayRetry" mode="sync" result-to-context="true"/>
    	<action service="prepareOrderEmailData" mode="sync" result-to-context="false" result-map-name="templateData"/>
    </eca>
    <eca service="sendOrderPayRetryNotification" event="commit">
    	<action service="createOrderNotificationLog" mode="sync"/>
    </eca>

	<!-- Order Delivery Schedule ECAs -->
    <eca service="createOrderDeliverySchedule" event="commit">
    	<action service="sendOrderDeliveryScheduleNotification" mode="async" persist="true"/>
    </eca>
    <eca service="updateOrderDeliverySchedule" event="commit">
    	<action service="sendOrderDeliveryScheduleNotification" mode="async" persist="true"/>
    </eca>

    <!-- Return ECAs -->
    <eca service="updateReturnHeader" event="commit">
        <condition field-name="statusId" operator="equals" value="RETURN_ACCEPTED"/>
        <condition field-name="currentStatusId" operator="not-equals" value="RETURN_ACCEPTED"/>
        <action service="sendReturnAcceptNotification" mode="async" persist="true"/>
    </eca>
    <eca service="updateReturnHeader" event="commit">
        <condition field-name="statusId" operator="equals" value="RETURN_RECEIVED"/>
        <condition field-name="currentStatusId" operator="not-equals" value="RETURN_RECEIVED"/>
        <action service="processReplacementReturn" mode="sync"/>
        <action service="processCreditReturn" mode="sync"/>
        <action service="processRefundReturn" mode="sync"/>
    </eca>
    <eca service="updateReturnHeader" event="commit">
        <action service="checkReturnComplete" mode="sync"/>
    </eca>
    <eca service="updateReturnHeader" event="commit">
        <condition field-name="statusId" operator="equals" value="RETURN_CANCELLED"/>
        <condition field-name="currentStatusId" operator="not-equals" value="RETURN_CANCELLED"/>
        <action service="sendReturnCancelNotification" mode="async" persist="true"/>
    </eca>

    <eca service="updateReturnItem" event="commit">
        <condition field-name="statusId" operator="equals" value="RETURN_RECEIVED"/>
        <condition field-name="currentStatusId" operator="not-equals" value="RETURN_RECEIVED"/>
        <action service="resetGrandTotal" mode="sync"/>
    </eca>

    <eca service="updateReturnStatusFromReceipt" event="commit">
        <condition field-name="returnHeaderStatus" operator="equals" value="RETURN_RECEIVED"/>
        <action service="processReplacementReturn" mode="sync"/>
        <action service="processCreditReturn" mode="sync"/>
        <action service="processRefundReturn" mode="sync"/>
    </eca>

    <eca service="processReplacementReturn" event="commit">
        <action service="checkReturnComplete" mode="sync"/>
    </eca>
    <eca service="processCreditReturn" event="commit">
        <action service="checkReturnComplete" mode="sync"/>
    </eca>
    <eca service="processRefundReturn" event="commit">
        <action service="checkReturnComplete" mode="sync"/>
    </eca>

    <eca service="checkReturnComplete" event="commit">
        <condition field-name="statusId" operator="is-not-empty"/>
        <condition field-name="statusId" operator="equals" value="RETURN_COMPLETED"/>
        <action service="sendReturnCompleteNotification" mode="async" persist="true"/>
    </eca>

    <!-- ShoppingList ECAs -->
    <eca service="createShoppingListItem" event="in-validate">
        <condition field-name="shoppingListId" operator="is-empty"/>
        <action service="createShoppingList" mode="sync" result-to-context="true"/>
    </eca>

    <!-- CustRequest ECAs -->
    <eca service="createCustRequest" event="commit">
        <condition field-name="communicationEventId" operator="is-not-empty"/>
        <condition field-name="custRequestId" operator="is-not-empty"/>
        <action service="updateCommunicationEvent" mode="sync"/>
    </eca>

    <eca service="createCustRequest" event="commit">
        <condition field-name="communicationEventId" operator="is-not-empty"/>
        <condition field-name="custRequestId" operator="is-not-empty"/>
        <action service="updateCommunicationEvent" mode="sync"/>
    </eca>
    
    <!-- Requirement / CustRequestItem association event -->
    <eca service="createRequirement" event="commit">
    	<condition field-name="custRequestId" operator="is-not-empty"/>
    	<condition field-name="custRequestItemSeqId" operator="is-not-empty"/>
    	<action service="associatedRequirementWithRequestItem" mode="sync"/>
    </eca>
</service-eca>
