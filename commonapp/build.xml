<?xml version="1.0"?>

<project name="Open For Business CommonApp Component" default="ear" basedir=".">


    <!-- ================================================================== -->
    <!-- Initialization of all property settings                            -->
    <!-- ================================================================== -->

    <target name="init">
		<property environment="env"                                 />
        <property name="name"           value="commonapp"           />
        <property name="src.dir"        value="src"                 />
        <property name="etc.dir"        value="etc"                 />
        <property name="lib.dir"        value="lib"                 />
		<property name="doc.dir"        value="docs"                />
        <property name="build.dir"      value="build"               />
        <property name="build.compiler" value="classic"             /> 
        <property name="pkg-dist.name"  value="${name}-pkg"         />
		
		<!-- Classpath setting -->
		<property name="core.jar"       value="../core/build/core.jar"             />		
		<property name="servlet.jar"    value="${env.TOMCAT_HOME}/lib/servlet.jar" />
		<property name="ejb.jar"        value="${env.JBOSS_HOME}/lib/ext/ejb.jar"  />
		<property name="jaxp.jar"       value="${env.JBOSS_HOME}/lib/jaxp.jar"     />
		<property name="parser.jar"     value="${env.JBOSS_HOME}/lib/xml.jar"      />
		<property name="api-jars"       value="${servlet.jar}:${ejb.jar}"          />
		<property name="xml-jars"       value="${jaxp.jar}:${parser.jar}"          />
		<property name="classpath"      value="${env.CLASSPATH}:${lib.dir}:${core.jar}:${api-jars}:${xml-jars}" />
		<echo message="classpath: ${classpath}" />
    </target>


    <!-- ================================================================== -->
    <!-- Removes all created files and directories                          -->
    <!-- ================================================================== -->

    <target name="clean" depends="init">
        <delete dir="${lib.dir}" />
        <delete dir="${build.dir}" />
    </target>

	<target name="prepare-docs" depends="init">
		<mkdir dir="${doc.dir}" />
		<mkdir dir="${doc.dir}/api" />
	</target>	


    <!-- ================================================================== -->
    <!-- Makes sure the needed directory structure is in place              -->
    <!-- ================================================================== -->

    <target name="prepare" depends="clean">
        <mkdir dir="${lib.dir}" />
		<mkdir dir="${lib.dir}/jar" />
		<mkdir dir="${lib.dir}/jar/META-INF" />
		<mkdir dir="${lib.dir}/ejb" />
		<mkdir dir="${lib.dir}/ejb/META-INF" />
		<mkdir dir="${lib.dir}/j2ee" />
		<mkdir dir="${lib.dir}/j2ee/META-INF" />
        <mkdir dir="${build.dir}" />
    </target>


    <!-- ================================================================== -->
    <!-- Compilation of the common application components                   -->
    <!-- ================================================================== -->


    <target name="classes" depends="prepare">
        <javac srcdir="${src.dir}"
		       classpath="${classpath}"
               destdir="${lib.dir}/jar" />               
    </target>

	<target name="jar-meta-info" depends="classes">
		<copy file="${src.dir}/META-INF/ejb-jar.xml"
		      tofile="${lib.dir}/jar/META-INF/jboss.xml" />
		<copy file="${src.dir}/META-INF/jboss.xml"
		      tofile="${lib.dir}/jar/META-INF/ejb-jar.xml" />
		<copy file="${src.dir}/META-INF/jaws.xml"
		      tofile="${lib.dir}/jar/META-INF/jaws.xml" />
	</target>


    <target name="jar" depends="jar-meta-info">
        <jar jarfile="${build.dir}/${name}.jar"
             basedir="${lib.dir}/jar" />
    </target>


    <!-- ================================================================== -->
    <!-- Build the WAR                                                      -->
    <!-- ================================================================== -->
	
	<target name="war" depends="prepare">
		<jar jarfile="${build.dir}/${name}.war"
		     basedir="./webapp" />
	</target>


    <!-- ================================================================== -->
    <!-- Build the EJB jar and EAR                                          -->
    <!-- ================================================================== -->
	
	<target name="meta-info" depends="jar,war">
		<copy file="${src.dir}/META-INF/ejb-jar.xml"
		      tofile="${lib.dir}/ejb/META-INF/jboss.xml" />
		<copy file="${src.dir}/META-INF/jboss.xml"
		      tofile="${lib.dir}/ejb/META-INF/ejb-jar.xml" />
		<copy file="${src.dir}/META-INF/jaws.xml"
		      tofile="${lib.dir}/ejb/META-INF/jaws.xml" />
		<copy file="${src.dir}/META-INF/application.xml"
		      tofile="${lib.dir}/j2ee/META-INF/application.xml" />			  
	</target>
	
	<target name="ejb" depends="meta-info">
		<jar jarfile="${lib.dir}/j2ee/${name}-ejb.jar"
		     basedir="${lib.dir}/ejb" />
	</target>
			 
	<target name="ear" depends="ejb">
		<jar jarfile="${build.dir}/${name}.ear"
		     basedir="${lib.dir}/j2ee" />
	</target>

	
    <!-- ================================================================== -->
    <!-- Build JavaDoc                                                      -->
    <!-- ================================================================== -->

	<target name="docs" depends="prepare-docs">
		<javadoc packagenames="org.ofbiz.*" classpath="${classpath}"
		         sourcepath="${src.dir}" destdir="${doc.dir}/api" />
	</target> 	


    <!-- ================================================================== -->
    <!-- Generates a GZip'ed tar source distribution                        -->
    <!-- ================================================================== -->

    <target name="pkg-dist" depends="prepare">

        <mkdir dir="${build.dir}/${name}" />

        <copy todir="${build.dir}/${name}">
            <fileset dir="." includes="${src.dir}/**" />            
            <fileset dir="." includes="build.xml" />
        </copy>

        <tar tarfile="${build.dir}/${pkg-dist.name}.tar"
             basedir="${build.dir}"
             includes="${name}/**" />

        <gzip src="${build.dir}/${pkg-dist.name}.tar"
              zipfile="${build.dir}/${pkg-dist.name}.tar.gz" />

        <delete file="${build.dir}/${pkg-dist.name}.tar" />

        <zip zipfile="${build.dir}/${pkg-dist.name}.zip"
             basedir="${build.dir}"
             includes="${name}/**" />

        <delete dir="${build.dir}/${name}" />

    </target>

    <target name="all" depends="jar,pkg-dist" />

</project>
